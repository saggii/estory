var child_process = require('child_process'),
    spawn = child_process.spawn,
    exec = child_process.exec,
    fs = require('fs-extra'),
    path = require('path');

var KARMA_CFG_PATH = path.resolve(__dirname, '../resources/karma.conf.js');

function runTests(directory, options) {
  exec('component test-build', { cwd: directory }, function(err, stdout, stderr) {
    if(err) {
      console.log("Error: %s", err.message);
      console.log(stderr);
      return process.exit(1);
    }
    spawnKarma(directory, options);
  });
}

function spawnKarma(directory, options) {
  var destCfg = path.resolve(directory, 'karma.conf.js');
  // Copy karma.conf.js to the directory
  fs.copy(KARMA_CFG_PATH, destCfg, function(err) {
    if(err) {
      throw err;
    }
    var browsersString = options.browsers.join(',');
    var continuous = options.continuous;
    // Run the tests
    var args = ['start', '--browsers', browsersString];
    if(!continuous) {
      args.push('--single-run');
    }
    var karma = spawn('karma', args, {
      cwd: directory
    });
    karma.stdout.on('data', function(data) {
      process.stdout.write(data);
    });
    karma.stderr.on('data', function(data) {
      process.stderr.write(data);
    });
    karma.on('close', function(code) {
      // Delete karma.conf.js
      try {
        fs.removeSync(destCfg);
      } catch(e) {
        console.log(e);
        return process.exit(1);
      }
      process.exit(code);
    });
  });
}

exports.runTests = runTests;
